<!DOCTYPE html>
<html lang="en">

<head>
	<title>Leaflet CloudRF Demo</title>
	<script src="CloudRF.js"></script>
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
		integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
		crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>
	<link rel="stylesheet" href="CloudRF.css">
</head>

<body>
	<!-- https://leafletjs.com/examples/quick-start/ -->
	<h2>Leaflet CloudRF Points API Demo</h2>

	<div id="mapid" class="map"></div>

	<p>Click the map to add a customer. Drag the tower and the customers to move them. To change RF settings, edit the template within CloudRF.js</p>
	<p>API reference: <a href="https://docs.cloudrf.com">docs.cloudrf.com</a></p>

	<script>
		var map = L.map('mapid').setView([38.916, 1.448], 12);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '<a href="https://cloudrf.com">CloudRF</a> | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		// Fetch lat/lon for all points on map
		function testAllPoints() {
			var apLat = 0;
			var apLon = 0;
			var customers = [];
			var customerHeightAGL = 4;

			map.eachLayer(function (layer) {
				if (layer.options.title === "AP") {
					apLat = layer.getLatLng().lat;
					apLon = layer.getLatLng().lng;
				}
				if (layer.options.title === "CPE") {
					customers.push({ "lat": layer.getLatLng().lat, "lon": layer.getLatLng().lng, "alt": customerHeightAGL });
				}
			});

			createPoints(apLat, apLon, customers);
		}
		var LeafIcon = L.Icon.extend({
			options: {
				iconSize: [50, 50],
				iconAnchor: [25, 25],
				popupAnchor: [0, 0]
			}
		});

		var towerIcon = new LeafIcon({
			iconUrl: 'images/tower.png'
		})

		var cpeIcon = new LeafIcon({
			iconUrl: 'images/CPE.png'
		})

		function addAP(latitude, longitude) {
			ap = new L.marker([latitude, longitude], { title: 'AP', draggable: 'true', icon: towerIcon });
			map.addLayer(ap);
			ap.on('dragend', function (event) {
				var marker = event.target;
				var position = marker.getLatLng();
				marker.setLatLng(new L.LatLng(position.lat, position.lng), { draggable: 'true' });
				testAllPoints();
			});
		}

		function addCPE(latitude, longitude) {
			ap = new L.marker([latitude, longitude], { title: 'CPE', draggable: 'true', icon: cpeIcon });
			map.addLayer(ap);
			return ap;
		}

		function onMapClick(e) {
			marker = addCPE(e.latlng.lat, e.latlng.lng);
			marker.on('dragend', function (event) {
				var marker = event.target;
				var position = marker.getLatLng();
				marker.setLatLng(new L.LatLng(position.lat, position.lng), { draggable: 'true' });
				testAllPoints();
			});
			testAllPoints();
		};

		// ADD AP
		addAP(38.93, 1.43);

		// ADD CPE
		map.on('click', onMapClick);

	</script>
</body>

</html>