<!DOCTYPE html>
<html lang="en">

<head>
    <title>Leaflet CloudRF Demo</title>
    <script src="CloudRF.js"></script>
    <script src="radioTemplates.js"></script>
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <link rel="stylesheet" href="CloudRF.css">
</head>

<body>
    <h2>CloudRF Path API Demo</h2>

    <p>Drag the markers to position them. Edit RF settings in radioTemplates.js</p>
    <p>Template <select id="templateSelect" class="mr-1"></select><a href="#" onclick="testPath()">Go</a></p>

    <div id="mapid" class="map"></div>
    <div id="chart"></div>
    <div id="report"></div>

    <p>
        <a href="https://cloudrf.com/documentation/developer/swagger-ui/">API schema</a>
        <a href="https://leafletjs.com/examples/quick-start/">Map documentation</a>
    </p>

    <script>
        var map = L.map('mapid').setView([38.93, 1.448], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '<a href="https://cloudrf.com">CloudRF</a> | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fetch lat/lon for all points on map
        function testPath() {
            var txLat = 0;
            var txLon = 0;
            var rxLat = 0;
            var rxLon = 0;
            var request = myTemplates[document.getElementById("templateSelect").value];


            map.eachLayer(function (layer) {
                if (layer.options.title === "Tx") {
                    txLat = layer.getLatLng().lat;
                    txLon = layer.getLatLng().lng;
                }
                if (layer.options.title === "Rx") {
                    rxLat = layer.getLatLng().lat;
                    rxLon = layer.getLatLng().lng;
                }
            });

            // update the JSON with our locations
            request.transmitter.lat = txLat;
            request.transmitter.lon = txLon;
            request.receiver.lat = rxLat;
            request.receiver.lon = rxLon;
            request.antenna.azi = bearing(txLat, txLon, rxLat, rxLon);

            // API accepts a JSON string in the body
            console.log(request);
            CloudRFPathAPI(JSON.stringify(request));

        }
        var LeafIcon = L.Icon.extend({
            options: {
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, 0]
            }
        });

        var antIcon = new LeafIcon({
            iconUrl: 'marker.png'
        })


        function addTx(latitude, longitude) {
            ap = new L.marker([latitude, longitude], { title: 'Tx', draggable: 'true', icon: antIcon });
            map.addLayer(ap);
            ap.on('dragend', function (event) {
                var marker = event.target;
                var position = marker.getLatLng();
                marker.setLatLng(new L.LatLng(position.lat, position.lng), { draggable: 'true' });
                testPath();
            });
        }

        function addRx(latitude, longitude) {
            ap = new L.marker([latitude, longitude], { title: 'Rx', draggable: 'true', icon: antIcon });
            map.addLayer(ap);
            ap.on('dragend', function (event) {
                var marker = event.target;
                var position = marker.getLatLng();
                marker.setLatLng(new L.LatLng(position.lat, position.lng), { draggable: 'true' });
                testPath();
            });
        }

        // Add our markers for the path
        addTx(38.92957, 1.417623);
        addRx(38.91915, 1.4647);

        // populate templates
        var options = "";

        for (var t = 0; t < myTemplates.length; t++) {
            console.log(myTemplates[t].site);
            options = options + "<option value='" + t + "'>" + myTemplates[t].site + "</option>\n";
        }
        document.getElementById("templateSelect").innerHTML = options; // "sing a song of old school I don't really care..."

        testPath();

    </script>

</body>

</html>